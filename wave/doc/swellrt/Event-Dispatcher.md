# Event Dispatcher

## Introduction

This document shows how to implement the following event dispatch scenario:
We want to notify to a third party tag extractor system every time a document's text is updated.
The tag extractor tag will process the document's text and will update the document's tag list.
To implement this scenario with SwellRT follow these steps:

1) Define event rules to trigger events on document text changes
2) Dispatch events to 3rd party system as HTTP request
3) Update the document's tags using SwellRT REST service 

## Event rules

A event rule triggers a new event when a collaborative object's change matches the defined "type" and "conditions" for and specific field path.

Edit the "event-rules.config" in the configuration folder of the SwellRT installation. 
Add following JSON object to define a rule that will trigger events:

```
[
   {
        "id":"textupdate",
        "app":"default",
        "dataType":"default",
        "conditions":[
        ],
        "type":"DOC_CHANGE",
        "path":"root.doc",
        "targets":{
            "http":{
                "text":"${root.doc}",
                "extra":"some extra value"
            }
        }
    }
]
``` 

- `id` is a unique string to identify this rule.
- `app` and `dataType` are reserved for future use. Use "default" as value.
- `conditions` are JSON objects having fields with an object path expression as key and the expected value as value. 
- `type` of the collaborative object change to be detected. Possible values are `MAP_ENTRY_UPDATED`, `MAP_ENTRY_REMOVED`, `LIST_ITEM_ADDED`, `LIST_ITEM_REMOVED` and `DOC_CHANGE.
- `path` to the field in the collaborative object expecting to raise the event.
- `targets` are objects configuring the data to be sent on each event to different event dispatchers. `http` indicates that events generated by this rule will be dispatched to the HTTP dispatcher with the inner data.

## Dispatch events through HTTP

SwellRT provides a generic HTTP dispatcher. It sends HTTP POST requests to a specific endpoint with a JSON payload defined in the event rule.

Event dispatchers are configured in the application configuration file `application.conf` (see `reference.conf` for default values).

In this example, add following lines to the `application.conf` file:

```
dispatch {

	http { 
	
	 textupdate {
	
		host: "http://myhost.com"
		contentType: "application/json"
		headers: ["x-header-one: key=value1", "x-header-two: key=value2"]		
	 
	 }
	 
	}
}
```

In the "dispatch" section there is a subsection for each available dispatcher in SwellRT. In this case, "http" refers to the provided generic HTTP dispatcher.

Within each dispatcher section, add a object for each event rule, configuring the specific HTTP request to execute.
In this example "textupdate" is the name of the event rules previously defined. An example of HTTP body of a request follows:

```
{ 
	"path" : "root.doc", 
	"data" : 
			{ 
				"extra" : "some extra value",
				"text" : "<here some text>"
			  },			  
	 "waveid":"local.net/s+u28k4lqPkpA"}
```
 
## Updating collaborative objects with REST API

In order to use the REST API an authenticated HTTP session must be open:

```
POST http://localhost:9898/swell/auth

{
	"id" : "user@local.net",
	"password" : "password"
}
```
The method will set a cookie session named "WSESSIONID" if login is successful. 
Send this cookie in the next requests to get access to the objects.

### Getting object data

To get a field value of the object use a GET request. To get the document content in the example:

```
GET http://localhost:9898/swell/object/local.net/s+u28k4lqPkpA/doc
```

NOTE: in event rules, path expressions start with the virtual field "root". In the REST API paths are build without the root field.

- Path in event rule: "root.doc"
- Path in REST API: "doc"

### Updating object data

To update a field in a collaborative object use a POST request as follows: 

```
POST http://localhost:9898/swell/object/<waveid>/<path to the field>

<JSON object>
```

Following the tags example, it would be something like this:

```
POST http://localhost:9898/swell/object/local.net/s+u28k4lqPkpA/tags

["tagOne", "tagTwo", "tagThree"]
```

